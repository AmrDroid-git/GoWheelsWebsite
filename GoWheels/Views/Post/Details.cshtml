@model GoWheels.Models.Post

@{
    ViewData["Title"] = "Details";
}

<h1>Details</h1>

<div>
    <h4>Post</h4>
    <hr />
    
    <div class="row">
        <div class="col-md-8">
            <dl class="row">
                <dt class = "col-sm-4">
                    @Html.DisplayNameFor(model => model.CreatedAt)
                </dt>
                <dd class = "col-sm-8">
                    @Html.DisplayFor(model => model.CreatedAt)
                </dd>
                <dt class = "col-sm-4">
                    @Html.DisplayNameFor(model => model.Status)
                </dt>
                <dd class = "col-sm-8">
                    @Html.DisplayFor(model => model.Status)
                </dd>
                <dt class = "col-sm-4">
                    @Html.DisplayNameFor(model => model.RateAverage)
                </dt>
                <dd class = "col-sm-8">
                    <span id="postRateAverage">@(Model.RateAverage?.ToString("F1") ?? "N/A")</span>
                    <small class="text-muted">(@Model.RatingsCount ratings)</small>
                </dd>
                <dt class = "col-sm-4">
                    @Html.DisplayNameFor(model => model.Constructor)
                </dt>
                <dd class = "col-sm-8">
                    @Html.DisplayFor(model => model.Constructor)
                </dd>
                <dt class = "col-sm-4">
                    @Html.DisplayNameFor(model => model.ModelName)
                </dt>
                <dd class = "col-sm-8">
                    @Html.DisplayFor(model => model.ModelName)
                </dd>
                <dt class = "col-sm-4">
                    @Html.DisplayNameFor(model => model.ReleaseDate)
                </dt>
                <dd class = "col-sm-8">
                    @Html.DisplayFor(model => model.ReleaseDate)
                </dd>
                <dt class = "col-sm-4">
                    @Html.DisplayNameFor(model => model.PurchaseDate)
                </dt>
                <dd class = "col-sm-8">
                    @Html.DisplayFor(model => model.PurchaseDate)
                </dd>
                <dt class = "col-sm-4">
                    @Html.DisplayNameFor(model => model.Kilometrage)
                </dt>
                <dd class = "col-sm-8">
                    @Html.DisplayFor(model => model.Kilometrage)
                </dd>
                <dt class = "col-sm-4">
                    @Html.DisplayNameFor(model => model.Price)
                </dt>
                <dd class = "col-sm-8">
                    @Html.DisplayFor(model => model.Price)
                </dd>
                <dt class = "col-sm-4">
                    @Html.DisplayNameFor(model => model.Specifications)
                </dt>
                <dd class = "col-sm-8">
                    @if (Model.Specifications.Count != 0)
                    {
                        <ul class="list-unstyled mb-0">
                            @foreach (var spec in Model.Specifications)
                            {
                                <li><strong>@spec.Key:</strong> @spec.Value</li>
                            }
                        </ul>
                    }
                    else
                    {
                        <span class="text-muted">No specifications provided.</span>
                    }
                </dd>
                <dt class = "col-sm-4">
                    @Html.DisplayNameFor(model => model.Owner)
                </dt>
                <dd class = "col-sm-8">
                    <a asp-controller="User" asp-action="Details" asp-route-id="@Model.OwnerId">@Model.Owner.Name</a>
                </dd>
            </dl>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Rate this Car</h5>
                </div>
                <div class="card-body text-center">
                    <div id="postRatingStars" class="fs-2 text-warning mb-3" style="cursor: pointer;">
                        <i class="bi bi-star" data-value="1"></i>
                        <i class="bi bi-star" data-value="2"></i>
                        <i class="bi bi-star" data-value="3"></i>
                        <i class="bi bi-star" data-value="4"></i>
                        <i class="bi bi-star" data-value="5"></i>
                    </div>
                    <button id="submitPostRating" class="btn btn-warning w-100">Submit Rating</button>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <h5>Images</h5>
            <div class="row">
                @foreach (var postImage in Model.PostImages)
                {
                    <div class="col-md-3 mb-3">
                        <img src="@postImage.ImageUrl" alt="@Model.ModelName Image" class="img-fluid rounded shadow-sm" style="height: 200px; width: 100%; object-fit: cover;"/>
                    </div>
                }
                @if (!Model.PostImages.Any())
                {
                    <div class="col-12">
                        <div class="alert alert-light border">No images available for this post.</div>
                    </div>
                }
            </div>
        </div>
    </div>

    <hr />

    <!-- Comments Section -->
    <div class="row mt-4">
        <div class="col-md-8">
            <h4>Comments (<span id="commentCount">@Model.Comments.Count</span>)</h4>
            
            <div id="commentList" class="mt-3">
                @foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedAt))
                {
                    <div class="card mb-3 shadow-sm border-0 bg-light" id="comment-@comment.Id">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <h6 class="card-subtitle mb-2 text-primary">@comment.User.Name</h6>
                                <small class="text-muted">@comment.CreatedAt.ToString("g")</small>
                            </div>
                            <p class="card-text">@comment.Body</p>
                            @if (User.Identity.IsAuthenticated && (User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value == comment.UserId || User.IsInRole("ADMIN")))
                            {
                                <button class="btn btn-sm btn-link text-danger p-0 delete-comment" data-id="@comment.Id">Delete</button>
                            }
                        </div>
                    </div>
                }
                @if (!Model.Comments.Any())
                {
                    <div id="noCommentsMessage" class="alert alert-info">No comments yet. Be the first to comment!</div>
                }
            </div>

            @if (User.Identity.IsAuthenticated)
            {
                <div class="card mt-4 shadow-sm">
                    <div class="card-body">
                        <h6>Leave a Comment</h6>
                        <div class="mb-3">
                            <textarea id="commentBody" class="form-control" rows="3" placeholder="Write your comment here..."></textarea>
                        </div>
                        <button id="submitComment" class="btn btn-primary">Post Comment</button>
                    </div>
                </div>
            }
            else
            {
                <div class="alert alert-warning mt-4">
                    Please <a href="/Identity/Account/Login">login</a> to leave a comment.
                </div>
            }
        </div>
    </div>
</div>
<div>
    <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-outline-primary">Edit</a> |
    <a asp-action="Index" class="btn btn-outline-secondary">Back to List</a>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            const postId = "@Model.Id";
            let selectedRating = 0;

            // Rating Stars Hover/Click
            $('#postRatingStars i').hover(function () {
                const val = $(this).data('value');
                fillStars(val);
            }, function () {
                fillStars(selectedRating);
            }).click(function () {
                selectedRating = $(this).data('value');
                fillStars(selectedRating);
            });

            function fillStars(val) {
                $('#postRatingStars i').each(function () {
                    const starVal = $(this).data('value');
                    if (starVal <= val) {
                        $(this).removeClass('bi-star').addClass('bi-star-fill');
                    } else {
                        $(this).removeClass('bi-star-fill').addClass('bi-star');
                    }
                });
            }

            // Submit Rating
            $('#submitPostRating').click(function () {
                if (selectedRating === 0) {
                    alert('Please select a rating value.');
                    return;
                }

                $.ajax({
                    url: '/api/Rating/Post',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        postId: postId,
                        value: selectedRating
                    }),
                    success: function (response) {
                        alert('Thank you for your rating!');
                        location.reload(); // Simplest way to update averages for now
                    },
                    error: function (xhr) {
                        if (xhr.status === 401) {
                            alert('Please login to rate.');
                        } else {
                            alert('Error: ' + (xhr.responseText || 'Failed to submit rating.'));
                        }
                    }
                });
            });

            // Submit Comment
            $('#submitComment').click(function () {
                const body = $('#commentBody').val();
                if (!body.trim()) {
                    alert('Comment cannot be empty.');
                    return;
                }

                $(this).prop('disabled', true).text('Posting...');

                $.ajax({
                    url: '/api/Comment',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        postId: postId,
                        body: body
                    }),
                    success: function (comment) {
                        $('#commentBody').val('');
                        $('#noCommentsMessage').remove();
                        
                        const commentHtml = `
                            <div class="card mb-3 shadow-sm border-0 bg-light" id="comment-${comment.id}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <h6 class="card-subtitle mb-2 text-primary">${comment.userName}</h6>
                                        <small class="text-muted">Just now</small>
                                    </div>
                                    <p class="card-text">${comment.body}</p>
                                    <button class="btn btn-sm btn-link text-danger p-0 delete-comment" data-id="${comment.id}">Delete</button>
                                </div>
                            </div>
                        `;
                        $('#commentList').prepend(commentHtml);
                        
                        const countSpan = $('#commentCount');
                        countSpan.text(parseInt(countSpan.text()) + 1);
                    },
                    error: function (xhr) {
                        alert('Error: ' + (xhr.responseText || 'Failed to post comment.'));
                    },
                    complete: function() {
                        $('#submitComment').prop('disabled', false).text('Post Comment');
                    }
                });
            });

            // Delete Comment
            $(document).on('click', '.delete-comment', function () {
                const btn = $(this);
                const commentId = btn.data('id');

                if (!confirm('Are you sure you want to delete this comment?')) return;

                $.ajax({
                    url: '/api/Comment/' + commentId,
                    type: 'DELETE',
                    success: function () {
                        $(`#comment-${commentId}`).fadeOut(300, function() {
                            $(this).remove();
                            const countSpan = $('#commentCount');
                            countSpan.text(parseInt(countSpan.text()) - 1);
                            
                            if ($('#commentList').children().length === 0) {
                                $('#commentList').append('<div id="noCommentsMessage" class="alert alert-info">No comments yet. Be the first to comment!</div>');
                            }
                        });
                    },
                    error: function (xhr) {
                        alert('Error: ' + (xhr.responseText || 'Failed to delete comment.'));
                    }
                });
            });
        });
    </script>
}
