@model GoWheels.Models.Post

@{
    ViewData["Title"] = $"{Model.Constructor} {Model.ModelName} - Details";
    var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var isUser = User.IsInRole("USER");
    var isAdmin = User.IsInRole("ADMIN");
    var isExpert = User.IsInRole("EXPERT");
    var isOwner = userId == Model.OwnerId;
    bool loggedIn = User.Identity?.IsAuthenticated == true;
    bool canComment = isUser || isExpert;
    bool canRate = (isUser && !isOwner) || isExpert;

    var mainImage = Model.PostImages?.FirstOrDefault()?.ImageUrl ?? "/images/no-car.jpg";
}

<link rel="stylesheet" href="~/css/post-details.css" asp-append-version="true" />

<!-- Hero Section with Main Image Background -->
<div class="details-hero">
    <div class="details-hero-bg" style="background-image: url('@mainImage');"></div>

    <!-- Price Badge -->
    <div class="price-badge">
        <div class="price-badge-label">Price</div>
        <div class="price-badge-value">@Model.Price.ToString("N0") DT</div>
    </div>

    <div class="details-hero-content">
        <h1 class="details-title">@Model.Constructor @Model.ModelName</h1>

        <div class="details-meta">
            <div class="details-meta-item">
                <i class="fa-solid fa-calendar"></i>
                <span>@Model.PurchaseDate.ToString("yyyy")</span>
            </div>
            <div class="details-meta-item">
                <i class="fa-solid fa-tachometer-alt"></i>
                <span>@((Model.Kilometrage / 1000).ToString())K km</span>
            </div>
            <div class="details-meta-item">
                <i class="fa-solid fa-star"></i>
                <span id="postRateAverage">@(Model.RateAverage?.ToString("F1") ?? "N/A")</span> (@Model.RatingsCount reviews)
            </div>
            <div class="details-meta-item">
                <partial name="_StatusPill" model="Model.Status" />
            </div>
        </div>
    </div>
</div>

<div class="container-fluid px-4 py-5" style="max-width: 1400px;">
    <!-- Image Gallery Section -->
    @if (Model.PostImages != null && Model.PostImages.Any())
    {
        <div class="details-section">
            <div class="section-header">
                <div class="section-icon">
                    <i class="fa-solid fa-images"></i>
                </div>
                <h2 class="section-title">Photo Gallery</h2>
            </div>

            <div class="image-gallery-modern">
                <!-- Main Image Display -->
                <div class="gallery-main-image" id="mainGalleryImage" data-index="0">
                    <img src="@mainImage" alt="@Model.ModelName" id="mainImg">
                    <div class="gallery-zoom-hint">
                        <i class="fa-solid fa-search-plus"></i>
                        <span>Click to zoom</span>
                    </div>
                </div>

                <!-- Thumbnail Grid -->
                <div class="gallery-thumbnails">
                    @for (int i = 0; i < Model.PostImages.Count; i++)
                    {
                        <div class="gallery-thumbnail @(i == 0 ? "active" : "")" data-index="@i" data-image="@Model.PostImages.ElementAt(i).ImageUrl">
                            <img src="@Model.PostImages.ElementAt(i).ImageUrl" alt="@Model.ModelName - Image @(i + 1)">
                        </div>
                    }
                </div>
            </div>
        </div>
    }

    <!-- Specifications Section -->
    <div class="details-section">
        <div class="section-header">
            <div class="section-icon">
                <i class="fa-solid fa-cogs"></i>
            </div>
            <h2 class="section-title">Specifications</h2>
        </div>

        <div class="specs-grid">
            <!-- Basic Information Card -->
            <div class="spec-card">
                <h4 class="mb-4" style="color: #667eea; font-weight: 700;">
                    <i class="fa-solid fa-info-circle me-2"></i>Basic Information
                </h4>

                <div class="spec-item">
                    <div class="spec-label">
                        <i class="fa-solid fa-money-bill-wave"></i>
                        <span>Price</span>
                    </div>
                    <div class="spec-value highlight">@Model.Price.ToString("N0") DT</div>
                </div>

                <div class="spec-item">
                    <div class="spec-label">
                        <i class="fa-solid fa-star"></i>
                        <span>Price Rating</span>
                    </div>
                    <div class="spec-value" style="color: #ffc107;">
                        @(Model.RateAverage?.ToString("F1") ?? "N/A")
                        <small style="color: #6c757d;">(@Model.RatingsCount)</small>
                    </div>
                </div>

                <div class="spec-item">
                    <div class="spec-label">
                        <i class="fa-solid fa-tachometer-alt"></i>
                        <span>Kilometrage</span>
                    </div>
                    <div class="spec-value">@((Model.Kilometrage / 1000).ToString())K km</div>
                </div>

                <div class="spec-item">
                    <div class="spec-label">
                        <i class="fa-solid fa-calendar-alt"></i>
                        <span>Purchase Date</span>
                    </div>
                    <div class="spec-value">@Model.PurchaseDate.ToString("yyyy-MM-dd")</div>
                </div>

                <div class="spec-item">
                    <div class="spec-label">
                        <i class="fa-solid fa-calendar"></i>
                        <span>Release Date</span>
                    </div>
                    <div class="spec-value">@Model.ReleaseDate.ToString("yyyy-MM-dd")</div>
                </div>

                @if (Model.Specifications.ContainsKey("Gouvernorat"))
                {
                    <div class="spec-item">
                        <div class="spec-label">
                            <i class="fa-solid fa-map-marker-alt"></i>
                            <span>Location</span>
                        </div>
                        <div class="spec-value">@Model.Specifications["Gouvernorat"]</div>
                    </div>
                }
            </div>

            <!-- Technical Specifications Card -->
            <div class="spec-card">
                <h4 class="mb-4" style="color: #667eea; font-weight: 700;">
                    <i class="fa-solid fa-tools me-2"></i>Technical Details
                </h4>

                @{
                    var techSpecs = new Dictionary<string, string>
                    {
                        { "Gearbox", "fa-solid fa-cog" },
                        { "Transmission", "fa-solid fa-sync-alt" },
                        { "Énergie", "fa-solid fa-gas-pump" },
                        { "Carrosserie", "fa-solid fa-car" },
                        { "État général", "fa-solid fa-check-circle" },
                        { "Anciens propriétaires", "fa-solid fa-users" },
                        { "Puissance fiscale", "fa-solid fa-gauge" }
                    };

                    var hasSpecs = false;
                    foreach (var spec in techSpecs)
                    {
                        if (Model.Specifications.ContainsKey(spec.Key))
                        {
                            hasSpecs = true;
                            <div class="spec-item">
                                <div class="spec-label">
                                    <i class="@spec.Value"></i>
                                    <span>@spec.Key</span>
                                </div>
                                @if (spec.Key == "État général")
                                {
                                    var etat = Model.Specifications[spec.Key];
                                    var etatColor = etat == "Normal" ? "#ffc107" : etat == "Bon" ? "#28a745" : etat == "Très bon" ? "#20c997" : "#6c757d";
                                    <div class="spec-value" style="color: @etatColor;">@etat</div>
                                }
                                else
                                {
                                    <div class="spec-value">@Model.Specifications[spec.Key]</div>
                                }
                            </div>
                        }
                    }

                    // Show other specs not in the predefined list
                    foreach (var spec in Model.Specifications)
                    {
                        if (!techSpecs.ContainsKey(spec.Key) && spec.Key != "Gouvernorat")
                        {
                            hasSpecs = true;
                            <div class="spec-item">
                                <div class="spec-label">
                                    <i class="fa-solid fa-list"></i>
                                    <span>@spec.Key</span>
                                </div>
                                <div class="spec-value">@spec.Value</div>
                            </div>
                        }
                    }

                    if (!hasSpecs)
                    {
                        <div class="text-center text-muted py-4">
                            <i class="fa-solid fa-info-circle me-2"></i>
                            No additional technical specifications provided
                        </div>
                    }
                }
            </div>
        </div>
    </div>


    <!-- Expert Review Section (only for pending posts viewed by experts) -->
    @if (isExpert && !isOwner && Model.Status == GoWheels.Models.PostStatus.Pending)
    {
        <div class="expert-review-section">
            <div class="expert-review-header">
                <i class="fa-solid fa-clipboard-check" style="font-size: 2rem; color: #ff9800;"></i>
                <h3 style="margin: 0; color: #2c3e50; font-weight: 700;">Expert Review Required</h3>
            </div>

            <div class="alert alert-warning mb-4" style="border-left: 4px solid #ff9800;">
                <i class="fa-solid fa-exclamation-triangle me-2"></i>
                This post is awaiting your professional review. Please examine all details carefully before making a decision.
            </div>

            <div class="expert-review-buttons">
                <button type="button"
                        class="btn-action btn-action-success expert-action-btn"
                        data-action="AcceptPost"
                        data-id="@Model.Id">
                    <i class="fa-solid fa-check me-2"></i>Accept Post
                </button>
                <button type="button"
                        class="btn-action btn-action-danger expert-action-btn"
                        data-action="RejectPost"
                        data-id="@Model.Id">
                    <i class="fa-solid fa-times me-2"></i>Reject Post
                </button>
            </div>
        </div>
    }

    <!-- Rating Section -->
    @if (canRate)
    {
        <div class="details-section">
            <div class="section-header">
                <div class="section-icon" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                    <i class="fa-solid fa-star"></i>
                </div>
                <h2 class="section-title">Rate this Vehicle</h2>
            </div>

            <div class="rating-container">
                <p style="font-size: 1.2rem; color: #6c757d; margin-bottom: 2rem;">
                    Share your experience with this vehicle by giving it a rating
                </p>

                <div class="rating-stars-large" id="postRatingStars">
                    <i class="bi bi-star" data-value="1"></i>
                    <i class="bi bi-star" data-value="2"></i>
                    <i class="bi bi-star" data-value="3"></i>
                    <i class="bi bi-star" data-value="4"></i>
                    <i class="bi bi-star" data-value="5"></i>
                </div>

                <button id="submitPostRating" class="rating-submit-btn">
                    <i class="fa-solid fa-paper-plane me-2"></i>Submit Rating
                </button>
            </div>
        </div>
    }

    <!-- Owner Information Section -->
    <div class="details-section">
        <div class="section-header">
            <div class="section-icon">
                <i class="fa-solid fa-user"></i>
            </div>
            <h2 class="section-title">Owner Information</h2>
        </div>

        <div class="owner-card">
            <div class="row align-items-center">
                <div class="col-md-3 text-center mb-4 mb-md-0">
                    <img src="@(Model.Owner.ImageUrl ?? "/images/default-avatar.png")"
                         class="owner-avatar"
                         alt="@Model.Owner.Name"
                         onerror="this.src='/images/default-avatar.png';">
                </div>
                <div class="col-md-9 owner-info">
                    <h3 class="owner-name">@Model.Owner.Name</h3>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="owner-detail">
                                <i class="fa-solid fa-phone"></i>
                                <span>@Model.Owner.PhoneNumber</span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="owner-detail">
                                <i class="fa-solid fa-envelope"></i>
                                <span>@Model.Owner.Email</span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="owner-detail">
                                <i class="fa-solid fa-map-marker-alt"></i>
                                <span>@(Model.Owner.Address ?? "Not provided")</span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="owner-detail">
                                <i class="fa-solid fa-car"></i>
                                <span>@Model.Owner.Posts.Count Total Posts</span>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <div class="owner-detail">
                                <i class="fa-solid fa-star"></i>
                                <span>
                                    @if (Model.Owner.RateAverage.HasValue && Model.Owner.RateAverage > 0)
                                    {
                                        for (int i = 1; i <= 5; i++)
                                        {
                                            if (i <= (int)Model.Owner.RateAverage)
                                            {
                                                <i class="bi bi-star-fill" style="color: #ffd700;"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-star" style="color: #ffd700;"></i>
                                            }
                                        }
                                        <span class="ms-2">@Model.Owner.RateAverage.Value.ToString("F1")/5.0</span>
                                    }
                                    else
                                    {
                                        <span>No ratings yet</span>
                                    }
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Comments Section -->
    <div class="details-section">
        <div class="section-header">
            <div class="section-icon">
                <i class="fa-solid fa-comments"></i>
            </div>
            <h2 class="section-title">
                Comments <span style="color: #667eea;">(<span id="commentCount">@Model.Comments.Count</span>)</span>
            </h2>
        </div>

        <div id="commentList">
            @foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedAt))
            {
                <partial name="_SingleComment" model="comment" />
            }

            @if (!Model.Comments.Any())
            {
                <div id="noCommentsMessage" class="alert alert-info" style="border-left: 4px solid #667eea;">
                    <i class="fa-solid fa-info-circle me-2"></i>
                    @if (canComment)
                    {
                        <span>No comments yet. Be the first to share your thoughts!</span>
                    }
                    else
                    {
                        <span>No comments on this post yet.</span>
                    }
                </div>
            }
        </div>

        @if (!loggedIn)
        {
            <div class="alert alert-warning mt-4" style="border-left: 4px solid #ff9800;">
                <i class="fa-solid fa-sign-in-alt me-2"></i>
                Please <a href="/Login" style="font-weight: 700; color: #667eea;">login</a> to leave a comment.
            </div>
        }
        else if (canComment)
        {
            <div class="comment-form">
                <h5 class="mb-3" style="color: #2c3e50; font-weight: 700;">
                    <i class="fa-solid fa-pen me-2"></i>Leave a Comment
                </h5>
                <textarea id="commentBody"
                          class="form-control comment-textarea"
                          rows="4"
                          placeholder="Share your thoughts about this vehicle..."></textarea>
                <button id="submitComment" class="btn-action btn-action-primary mt-3">
                    <i class="fa-solid fa-paper-plane me-2"></i>Post Comment
                </button>
            </div>
        }
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons-container">
        <div class="d-flex gap-3">
            @if (isAdmin || isOwner)
            {
                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn-action btn-action-primary">
                    <i class="fa-solid fa-pen me-2"></i>Edit Post
                </a>
                <a asp-action="Delete" asp-route-id="@Model.Id" class="btn-action btn-action-danger">
                    <i class="fa-solid fa-trash me-2"></i>Delete Post
                </a>
            }
        </div>
        <a asp-action="Index" class="btn-action btn-action-secondary">
            <i class="fa-solid fa-arrow-left me-2"></i>Back to Listings
        </a>
    </div>
</div>

<!-- Lightbox Modal -->
<div class="lightbox-modal" id="lightboxModal">
    <div class="lightbox-close" id="lightboxClose">
        <i class="fa-solid fa-times"></i>
    </div>
    <div class="lightbox-nav lightbox-prev" id="lightboxPrev">
        <i class="fa-solid fa-chevron-left"></i>
    </div>
    <div class="lightbox-content">
        <img src="" alt="Zoomed Image" id="lightboxImage">
    </div>
    <div class="lightbox-nav lightbox-next" id="lightboxNext">
        <i class="fa-solid fa-chevron-right"></i>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            const postId = "@Model.Id";
            let selectedRating = 0;

            // ==================== Image Gallery ====================
            const images = @Html.Raw(Json.Serialize(Model.PostImages?.Select(img => img.ImageUrl).ToList() ?? new List<string>()));
            let currentImageIndex = 0;

            // Thumbnail click
            $('.gallery-thumbnail').click(function() {
                const index = parseInt($(this).data('index'));
                const imageUrl = $(this).data('image');

                $('.gallery-thumbnail').removeClass('active');
                $(this).addClass('active');

                $('#mainImg').attr('src', imageUrl);
                $('#mainGalleryImage').data('index', index);
                currentImageIndex = index;
            });

            // Main image click - open lightbox
            $('#mainGalleryImage').click(function() {
                currentImageIndex = parseInt($(this).data('index'));
                openLightbox(currentImageIndex);
            });

            function openLightbox(index) {
                if (images.length === 0) return;

                currentImageIndex = index;
                $('#lightboxImage').attr('src', images[index]);
                $('#lightboxModal').addClass('active');
                $('body').css('overflow', 'hidden');
            }

            function closeLightbox() {
                $('#lightboxModal').removeClass('active');
                $('body').css('overflow', 'auto');
            }

            $('#lightboxClose, #lightboxModal').click(function(e) {
                if (e.target === this) {
                    closeLightbox();
                }
            });

            $('#lightboxPrev').click(function(e) {
                e.stopPropagation();
                currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
                $('#lightboxImage').attr('src', images[currentImageIndex]);
            });

            $('#lightboxNext').click(function(e) {
                e.stopPropagation();
                currentImageIndex = (currentImageIndex + 1) % images.length;
                $('#lightboxImage').attr('src', images[currentImageIndex]);
            });

            // Keyboard navigation
            $(document).keydown(function(e) {
                if (!$('#lightboxModal').hasClass('active')) return;

                if (e.key === 'Escape') closeLightbox();
                if (e.key === 'ArrowLeft') $('#lightboxPrev').click();
                if (e.key === 'ArrowRight') $('#lightboxNext').click();
            });

            // ==================== Rating System ====================
            $('#postRatingStars i').hover(function () {
                const val = $(this).data('value');
                fillStars(val);
            }, function () {
                fillStars(selectedRating);
            }).click(function () {
                selectedRating = $(this).data('value');
                fillStars(selectedRating);
            });

            function fillStars(val) {
                $('#postRatingStars i').each(function () {
                    const starVal = $(this).data('value');
                    if (starVal <= val) {
                        $(this).removeClass('bi-star').addClass('bi-star-fill');
                    } else {
                        $(this).removeClass('bi-star-fill').addClass('bi-star');
                    }
                });
            }

            // Submit Rating
            $('#submitPostRating').click(function () {
                if (selectedRating === 0) {
                    showToast('Please select a rating', 'Please select a star rating before submitting.', false);
                    return;
                }

                const btn = $(this);
                const originalText = btn.html();
                btn.prop('disabled', true).html('<span class="loading-spinner"></span> Submitting...');

                $.ajax({
                    url: '/api/Rating/Post',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        postId: postId,
                        value: selectedRating
                    }),
                    success: function (response) {
                        showToast('Success!', 'Thank you for your rating!', true);
                        setTimeout(() => location.reload(), 1500);
                    },
                    error: function (xhr) {
                        if (xhr.status === 401) {
                            showToast('Not Authorized', 'Please login to rate.', false);
                        } else {
                            showToast('Error', xhr.responseText || 'Failed to submit rating.', false);
                        }
                        btn.prop('disabled', false).html(originalText);
                    }
                });
            });

            // ==================== Comment System ====================
            $('#submitComment').click(function () {
                const body = $('#commentBody').val();
                if (!body.trim()) {
                    showToast('Empty Comment', 'Please write something before posting.', false);
                    return;
                }

                const btn = $(this);
                const originalText = btn.html();
                btn.prop('disabled', true).html('<span class="loading-spinner"></span> Posting...');

                $.ajax({
                    url: '/api/Comment',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        postId: postId,
                        body: body
                    }),
                    success: function (comment) {
                        $('#commentBody').val('');
                        $('#noCommentsMessage').remove();

                        // Create comment HTML using _SingleComment partial structure
                        const commentHtml = createCommentHTML(comment);
                        $('#commentList').prepend(commentHtml);

                        const countSpan = $('#commentCount');
                        countSpan.text(parseInt(countSpan.text()) + 1);

                        showToast('Success!', 'Your comment has been posted.', true);
                    },
                    error: function (xhr) {
                        showToast('Error', xhr.responseText || 'Failed to post comment.', false);
                    },
                    complete: function() {
                        btn.prop('disabled', false).html(originalText);
                    }
                });
            });

            // Delete Comment
            $(document).on('click', '.delete-comment', function () {
                const btn = $(this);
                const commentId = btn.data('id');

                if (!confirm('Are you sure you want to delete this comment?')) return;

                $.ajax({
                    url: '/api/Comment/' + commentId,
                    type: 'DELETE',
                    success: function () {
                        $(`#comment-${commentId}`).fadeOut(300, function() {
                            $(this).remove();
                            const countSpan = $('#commentCount');
                            countSpan.text(parseInt(countSpan.text()) - 1);

                            if ($('#commentList').children('.comment-card').length === 0) {
                                $('#commentList').prepend('<div id="noCommentsMessage" class="alert alert-info" style="border-left: 4px solid #667eea;"><i class="fa-solid fa-info-circle me-2"></i>No comments yet. Be the first to share your thoughts!</div>');
                            }
                        });
                        showToast('Deleted', 'Comment has been removed.', true);
                    },
                    error: function (xhr) {
                        showToast('Error', xhr.responseText || 'Failed to delete comment.', false);
                    }
                });
            });

            // Helper function to create comment HTML matching _SingleComment partial
            function createCommentHTML(comment) {
                return `
                    <div class="comment-card" id="comment-${comment.id}">
                        <div class="comment-header">
                            <img src="${comment.userImageUrl || '/images/default-avatar.png'}"
                                 class="comment-avatar"
                                 alt="${comment.userName}"
                                 onerror="this.src='/images/default-avatar.png';">
                            <div class="flex-grow-1">
                                <div class="comment-author">${comment.userName}</div>
                                <div class="comment-date">Just now</div>
                            </div>
                        </div>
                        <div class="comment-body">${escapeHtml(comment.body)}</div>
                        <button class="btn btn-sm btn-link text-danger p-0 delete-comment" data-id="${comment.id}">
                            <i class="fa-solid fa-trash me-1"></i>Delete
                        </button>
                    </div>
                `;
            }

            // Helper to escape HTML
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Toast notification function
            function showToast(title, message, isSuccess) {
                // Using the global toast function if available
                if (typeof showAjaxToast === 'function') {
                    showAjaxToast(title, message, isSuccess);
                } else {
                    alert(title + ': ' + message);
                }
            }
        });
    </script>
}
