@model GoWheels.Models.Post

@{
    ViewData["Title"] = "Details";
    var userId = User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value;
    var isUser = User.IsInRole("USER");
    var isAdmin = User.IsInRole("ADMIN");
    var isExpert = User.IsInRole("EXPERT");
    var isOwner = userId == Model.OwnerId;
    bool loggedIn = User.Identity?.IsAuthenticated == true;
    bool canComment = isUser || isExpert;
    bool canRate = (isUser && !isOwner) || isExpert;
}



        @*
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Rate this Car</h5>
                </div>
                <div class="card-body text-center">
                    <div id="postRatingStars" class="fs-2 text-warning mb-3" style="cursor: pointer;">
                        <i class="bi bi-star" data-value="1"></i>
                        <i class="bi bi-star" data-value="2"></i>
                        <i class="bi bi-star" data-value="3"></i>
                        <i class="bi bi-star" data-value="4"></i>
                        <i class="bi bi-star" data-value="5"></i>
                    </div>
                    <button id="submitPostRating" class="btn btn-warning w-100">Submit Rating</button>
                </div>
            </div>
        </div>
        *@



    
    @*
    <!-- Comments Section -->
    <div class="row mt-4">
        <div class="col-md-8">
            <h4>Comments (<span id="commentCount">@Model.Comments.Count</span>)</h4>
            
            <div id="commentList" class="mt-3">
                @foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedAt))
                {
                    <div class="card mb-3 shadow-sm border-0 bg-light" id="comment-@comment.Id">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <h6 class="card-subtitle mb-2 text-primary">@comment.User.Name</h6>
                                <small class="text-muted">@comment.CreatedAt.ToString("g")</small>
                            </div>
                            <p class="card-text">@comment.Body</p>
                            @if (User.Identity.IsAuthenticated && (User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value == comment.UserId || User.IsInRole("ADMIN")))
                            {
                                <button class="btn btn-sm btn-link text-danger p-0 delete-comment" data-id="@comment.Id">Delete</button>
                            }
                        </div>
                    </div>
                }
                @if (!Model.Comments.Any())
                {
                    <div id="noCommentsMessage" class="alert alert-info">No comments yet. Be the first to comment!</div>
                }
            </div>

            @if (User.Identity.IsAuthenticated)
            {
                <div class="card mt-4 shadow-sm">
                    <div class="card-body">
                        <h6>Leave a Comment</h6>
                        <div class="mb-3">
                            <textarea id="commentBody" class="form-control" rows="3" placeholder="Write your comment here..."></textarea>
                        </div>
                        <button id="submitComment" class="btn btn-primary">Post Comment</button>
                    </div>
                </div>
            } else {
                <div class="alert alert-warning mt-4">
                    Please <a href="/Identity/Account/Login">login</a> to leave a comment.
                </div>
            }
        </div>
    </div>
    *@


<div class="container-fluid mt-4 px-5">
    <div class="row">
        <div class="col-12">
            <!-- Header Section -->
            <div class="header-section mb-2 p-4">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="display-4 fw-bold mb-0 text-primary">@Model.Constructor @Model.ModelName</h1>
                </div>
            </div>
            <div class="d-flex justify-content-between mb-5">
                <span class="left-span">@Model.CreatedAt.ToString("yyyy-MM-dd HH:mm")</span>
                <div class="right-span">
                    <partial name="_StatusPill" model="Model.Status" />
                </div>
            </div>
<!-- Specifications Section -->
<div class="specifications-section mb-5 p-4 rounded" style="background-color: #f8f9fa; border: 1px solid #dee2e6;">
    <h2 class="mb-4 pb-2 text-success border-bottom border-success">Specifications</h2>
    <div class="row">
        <!-- Basic Information Column (LEFT) - KEEP THIS AS IS -->
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body py-4">
                    <h3 class="card-title mb-4 text-info">Basic Information</h3>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-bottom">
                            <span class="fs-5 text-primary"><i class="fa-solid fa-money-bill-wave me-3"></i>Price:</span>
                            <span class="fs-5 fw-bold text-success">@Model.Price.ToString("N0") DT</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-bottom">
                            <span class="fs-5 text-primary"><i class="fa-solid fa-star me-3"></i>Price Rating:</span>
                            <span class="fs-5 text-warning">
                                <span id="postRateAverage">@(Model.RateAverage?.ToString("F1") ?? "N/A")</span>
                                <small class="text-muted">(@Model.RatingsCount ratings)</small>
                            </span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-bottom">
                            <span class="fs-5 text-primary"><i class="fa-solid fa-tachometer-alt me-3"></i>Kilometrage:</span>
                            <span class="fs-5 text-dark">@((Model.Kilometrage / 1000).ToString())K km</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-bottom">
                            <span class="fs-5 text-primary"><i class="fa-solid fa-calendar-alt me-3"></i>Purchased:</span>
                            <span class="fs-5 text-dark">@Model.PurchaseDate.ToString("yyyy-MM-dd")</span>
                        </li>
                        <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                            <span class="fs-5 text-primary"><i class="fa-solid fa-calendar me-3"></i>Released At:</span>
                            <span class="fs-5 text-dark">@Model.ReleaseDate.ToString("yyyy-MM-dd")</span>
                        </li>
                        @if (Model.Specifications.ContainsKey("Gouvernorat"))
                        {
                            <li class="list-group-item d-flex justify-content-between align-items-center py-3">
                                <span class="fs-5 text-primary"><i class="fa-solid fa-map me-3"></i>Gouvernat:</span>
                                <span class="fs-5 text-dark">@Model.Specifications["Gouvernorat"]</span>
                            </li>
                        }
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Technical Specifications Column (RIGHT) - UPDATED -->
        <div class="col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body py-4">
                    <h3 class="card-title mb-4 text-info">Technical Specifications</h3>
                    <ul class="list-group list-group-flush">
                        @{
                            // Common specifications with icons
                            var commonSpecs = new Dictionary<string, string>
                            {
                                { "Gearbox", "fa-solid fa-cog" },
                                { "Transmission", "fa-solid fa-sync-alt" },
                                { "Énergie", "fa-solid fa-gas-pump" },
                                { "Carrosserie", "fa-solid fa-car" },
                                { "État général", "fa-solid fa-check-circle" },
                                { "Anciens propriétaires", "fa-solid fa-users" },
                                { "Puissance fiscale", "fa-solid fa-tachometer-alt" }
                            };
                            
                            // Show common specs first if they exist
                            foreach (var spec in commonSpecs)
                            {
                                @if (Model.Specifications.ContainsKey(spec.Key))
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-bottom">
                                        <span class="fs-5 text-primary"><i class="@spec.Value me-3"></i>@spec.Key:</span>
                                        @if (spec.Key == "État général")
                                        {
                                            <span class="fs-5 @(Model.Specifications[spec.Key] == "Normal" ? "text-warning" : Model.Specifications[spec.Key] == "Bon" ? "text-success" : Model.Specifications[spec.Key] == "Très bon" ? "text-success fw-bold" : "text-dark")">
                                                @Model.Specifications[spec.Key]
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="fs-5 text-dark">@Model.Specifications[spec.Key]</span>
                                        }
                                    </li>
                                }
                            }
                            
                            // Show other specifications (not in common list)
                            foreach (var spec in Model.Specifications)
                            {
                                @if (!commonSpecs.ContainsKey(spec.Key))
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center py-3 border-bottom">
                                        <span class="fs-5 text-primary"><i class="fa-solid fa-list me-3"></i>@spec.Key:</span>
                                        <span class="fs-5 text-dark">@spec.Value</span>
                                    </li>
                                }
                            }
                            
                            // If no specifications at all (excluding Gouvernorat which is in left column)
                            if (!Model.Specifications.Any() || Model.Specifications.Count == 1 && Model.Specifications.ContainsKey("Gouvernorat"))
                            {
                                <li class="list-group-item d-flex justify-content-center align-items-center py-3">
                                    <span class="fs-5 text-muted">No additional specifications provided</span>
                                </li>
                            }
                        }
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

            <!-- Image Gallery Section -->
            <div class="image-gallery-section mb-5 p-4 rounded" style="background-color: #f8f9fa; border: 1px solid #dee2e6;">
                <h2 class="mb-4 pb-2 text-danger border-bottom border-danger">Photos:</h2>
                @if (Model.PostImages.Any())
                {
                    <div id="postImageCarousel" class="carousel slide" data-bs-ride="carousel">
                        <div class="carousel-inner rounded">
                            @for (int i = 0; i < Model.PostImages.Count; i++)
                            {
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    <img src="@Model.PostImages.ElementAt(i).ImageUrl"
                                         class="d-block w-100"
                                         alt="@Model.ModelName"
                                         style="max-height: 600px; object-fit: cover;">
                                </div>
                            }
                        </div>
                        <button class="carousel-control-prev" type="button" data-bs-target="#postImageCarousel" data-bs-slide="prev">
                            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Previous</span>
                        </button>
                        <button class="carousel-control-next" type="button" data-bs-target="#postImageCarousel" data-bs-slide="next">
                            <span class="carousel-control-next-icon" aria-hidden="true"></span>
                            <span class="visually-hidden">Next</span>
                        </button>
                    </div>
                    <div class="mt-3" style="overflow-x: auto; white-space: nowrap;">
                        @for (int i = 0; i < Model.PostImages.Count; i++)
                        {
                            <div class="mb-3 col-4 d-inline-block">
                                <img src="@Model.PostImages.ElementAt(i).ImageUrl"
                                     class="img-thumbnail"
                                     alt="@Model.ModelName"
                                     style="cursor: pointer; height: 150px; object-fit: cover; border: 2px solid #dee2e6;"
                                     onclick="showImage(@i)">
                            </div>
                        }
                    </div>
                }
                else
                {
                    <div class="alert alert-info">
                        No images available for this post.
                    </div>
                }
            </div>

            <!-- Expert Review Buttons (for pending posts) -->
            @if (isExpert && !isOwner && Model.Status == GoWheels.Models.PostStatus.Pending)
            {
                <div class="expert-review-section mb-5 p-4 rounded" style="background-color: #f8f9fa; border: 1px solid #dee2e6;">
                    <h2 class="mb-4 pb-2 border-bottom" style="color: #6c757d;">
                        <i class="fa-solid fa-clipboard-check me-2"></i>Expert Review
                    </h2>
                    <div class="text-center p-4">
                        <div class="alert alert-warning mb-4">
                            <i class="fa-solid fa-exclamation-triangle me-2"></i>
                            This post is awaiting your review. Please examine the details carefully.
                        </div>
                        <div class="d-flex justify-content-center gap-3">
                            <form asp-controller="Expert" asp-action="AcceptPost" asp-route-id="@Model.Id" method="post">
                                <button type="submit" class="btn btn-success btn-lg px-5">
                                    <i class="fa-solid fa-check me-2"></i>Accept Post
                                </button>
                            </form>
                            <form asp-controller="Expert" asp-action="RejectPost" asp-route-id="@Model.Id" method="post">
                                <button type="submit" class="btn btn-danger btn-lg px-5">
                                    <i class="fa-solid fa-times me-2"></i>Reject Post
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            }

            <!-- Rating Section - Simple -->
            @if (canRate)
            {
                <div class="rating-section mb-5 p-4 rounded" style="background-color: #f8f9fa; border: 1px solid #dee2e6;">
                    <h2 class="mb-4 pb-2 text-warning border-bottom border-warning">
                        <i class="fa-solid fa-star me-2"></i>Rate this Car
                    </h2>
                    
                    <div class="text-center p-4">
                        <div id="postRatingStars" class="fs-1 text-warning mb-4" style="cursor: pointer;">
                            <i class="bi bi-star" data-value="1"></i>
                            <i class="bi bi-star" data-value="2"></i>
                            <i class="bi bi-star" data-value="3"></i>
                            <i class="bi bi-star" data-value="4"></i>
                            <i class="bi bi-star" data-value="5"></i>
                        </div>
                        
                        <button id="submitPostRating" class="btn btn-warning btn-lg px-5">
                            <i class="fa-solid fa-check me-2"></i>Submit Rating
                        </button>
                    </div>
                </div>
            }

            <!-- Owner Information Section -->
            <div class="owner-section mb-5 p-4 rounded" style="background-color: #f8f9fa; border: 1px solid #dee2e6;">
                <h2 class="mb-4 pb-2 text-dark border-bottom border-dark">Owner Information</h2>
                <div class="card border-0 shadow-sm">
                    <div class="card-body py-4">
                        <div class="row">
                            <div class="col-md-2 text-center">
                                <img src="@(Model.Owner.ImageUrl ?? "/avatar.jpg")"
                                     class="rounded-circle img-fluid"
                                     alt="@Model.Owner.Name"
                                     style="width: 120px; height: 120px; object-fit: cover; border: 3px solid #0d6efd;">
                            </div>
                            <div class="col-md-10">
                                <h3 class="card-title mb-3 text-primary">@Model.Owner.Name</h3>
                                </p>
                                <div class="row">
                                    <div class="col-md-6">
                                        <p class="card-text fs-5 mb-2 text-dark">
                                            <i class="fa-solid fa-phone me-3 text-success"></i>@Model.Owner.PhoneNumber
                                        </p>
                                        <p class="card-text fs-5 mb-2 text-dark">
                                            <i class="fa-solid fa-car me-3 text-info"></i>Total Posts: @Model.Owner.Posts.Count
                                        </p>
                                    </div>
                                    <div class="col-md-6">
                                        <p class="card-text fs-5 mb-2 text-dark">
                                            <i class="fa-solid fa-map-marker-alt me-3 text-danger"></i>@Model.Owner.Address
                                        </p>
                                        @{
                                            int rating = 3;//Model.Owner.RateAverage;
                                            int maxStars = 5; // Maximum number of stars
                                        }

                                        <p class="card-text fs-5 mb-2 text-dark">
                                            @if (rating > 0) // Check if the rating exists
                                            {
                                                for (int i = 0; i < maxStars; i++)
                                                {
                                                    if (i < rating)
                                                    {
                                                        <i class="bi bi-star-fill text-warning"></i> // Filled star for existing rating
                                                    }
                                                    else
                                                    {
                                                        <i class="bi bi-star"></i> // Empty star for the remaining stars
                                                    }
                                                }
                                            }
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

<!-- Comments Section -->
<div class="comments-section mb-5 p-4 rounded bg-light border">
    <h2 class="mb-4 pb-2 text-purple border-bottom border-purple">
        Comments (<span id="commentCount">@Model.Comments.Count</span>)
    </h2>

    <div class="card border-0 shadow-sm">
        <div class="card-body py-4">
            <div id="commentList" class="mt-3">
                @foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedAt))
                {
                    <partial name="_SingleComment" model="comment" />
                }

                @if (!Model.Comments.Any())
                {
                    <div id="noCommentsMessage" class="alert alert-info">
                        @if (canComment)
                        {
                            <i class="fa-solid fa-info-circle me-2"></i>
                            <span>No comments yet. Be the first to comment!</span>
                        }
                        else
                        {
                            <i class="fa-solid fa-info-circle me-2"></i>
                            <span>No comments on this post.</span>
                        }
                    </div>
                }
            </div>

            <!-- Comment UI / Login CTA -->
            @if (!loggedIn)
            {
                <div class="alert alert-warning mt-4">
                    Please <a href="/Login">login</a> to leave a comment.
                </div>
            }
            else if (canComment)
            {
                <div class="card mt-4 shadow-sm border-0">
                    <div class="card-body">
                        <h6>Leave a Comment</h6>
                        <div class="mb-3">
                            <textarea id="commentBody"
                                      class="form-control"
                                      rows="3"
                                      placeholder="Write your comment here..."></textarea>
                        </div>
                        <button id="submitComment" class="btn btn-primary">Post Comment</button>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

            <!-- Action Buttons -->
            <div class="action-buttons d-flex justify-content-between align-items-center py-4">
                @if (isAdmin || isOwner)
                {
                    <div class="d-flex">
                        <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-primary btn-lg me-3 px-4">
                            <i class="fa-solid fa-pen me-2"></i>Edit
                        </a>
                        <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger btn-lg px-4">
                            <i class="fa-solid fa-trash me-2"></i>Delete
                        </a>
                    </div>
                }
                <a asp-action="Index" class="btn btn-secondary btn-lg px-4">
                    <i class="fa-solid fa-arrow-left me-2"></i>Back to List
                </a>
            </div>
        </div>
    </div>
</div>

<style>
    .header-section {
        border-bottom: 2px solid #0d6efd;
    }

    h1, h2, h3, h4, h5 {
        font-weight: bold;
    }

    .text-purple {
        color: #6f42c1 !important;
    }

    .border-purple {
        border-color: #6f42c1 !important;
    }

    .list-group-item {
        border: none;
        border-bottom: 1px solid #dee2e6;
    }

    .card {
        border-radius: 10px;
    }

    .btn-lg {
        font-size: 1.25rem;
        padding: 0.75rem 1.5rem;
    }

    .fs-5 {
        font-size: 1.25rem !important;
    }

    .carousel-item img {
        height: 600px;
        object-fit: cover;
    }

    .img-thumbnail {
        cursor: pointer;
        transition: transform 0.3s;
        height: 150px;
        object-fit: cover;
        border: 2px solid #dee2e6;
    }

    .img-thumbnail:hover {
        transform: scale(1.05);
        border-color: #0d6efd;
    }

    .comment {
        background-color: #e9ecef;
        border: 1px solid #dee2e6;
    }

    .specifications-section, .image-gallery-section, .owner-section, .comments-section {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
    }


        .rating-section {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 10px;
    }
    
    .card {
        border-radius: 10px;
    }
    
    #postRatingStars i {
        transition: all 0.2s ease;
        margin: 0 3px;
    }
    
    #postRatingStars i:hover {
        transform: scale(1.2);
    }
    
    .progress {
        background-color: #e9ecef;
        border-radius: 5px;
    }
    
    .progress-bar {
        border-radius: 5px;
    }
    
    .border-warning {
        border-color: #ffc107 !important;
    }
</style>

@section Scripts {
    <script>
        $(document).ready(function () {
            const postId = "@Model.Id";
            let selectedRating = 0;

            
            // Rating Stars Hover/Click
            $('#postRatingStars i').hover(function () {
                const val = $(this).data('value');
                fillStars(val);
            }, function () {
                fillStars(selectedRating);
            }).click(function () {
                selectedRating = $(this).data('value');
                fillStars(selectedRating);
            });

            function fillStars(val) {
                $('#postRatingStars i').each(function () {
                    const starVal = $(this).data('value');
                    if (starVal <= val) {
                        $(this).removeClass('bi-star').addClass('bi-star-fill');
                    } else {
                        $(this).removeClass('bi-star-fill').addClass('bi-star');
                    }
                });
            }

            // Submit Rating
            $('#submitPostRating').click(function () {
                if (selectedRating === 0) {
                    alert('Please select a rating value.');
                    return;
                }

                $.ajax({
                    url: '/api/Rating/Post',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        postId: postId,
                        value: selectedRating
                    }),
                    success: function (response) {
                        alert('Thank you for your rating!');
                        location.reload(); // Simplest way to update averages for now
                    },
                    error: function (xhr) {
                        if (xhr.status === 401) {
                            alert('Please login to rate.');
                        } else {
                            alert('Error: ' + (xhr.responseText || 'Failed to submit rating.'));
                        }
                    }
                });
            });

            // Submit Comment
            $('#submitComment').click(function () {
                const body = $('#commentBody').val();
                if (!body.trim()) {
                    alert('Comment cannot be empty.');
                    return;
                }

                $(this).prop('disabled', true).text('Posting...');
                $.ajax({
                    url: '/api/Comment',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({
                        postId: postId,
                        body: body
                    }),
                    success: function (comment) {
                        $('#commentBody').val('');
                        $('#noCommentsMessage').remove();
                        
                        const commentHtml = `
                            <div class="comment mb-4 p-3 rounded bg-white border" id="comment-${comment.id}">
                                <div class="d-flex align-items-center mb-3">
                                    <img src="${comment.userImageUrl || '/avatar.jpg'}" onerror="this.onerror=null; this.src='/avatar.jpg';" class="rounded-circle me-3" style="width: 50px; height: 50px; object-fit: cover;">
                                    <div>
                                        <h5 class="mb-0">${comment.userName}</h5>
                                        <small class="text-muted">Just Now</small>
                                    </div>
                                </div>
                                <p class="mb-0">${comment.body}</p>
                                <button class="btn btn-sm btn-link text-danger p-0 delete-comment" data-id="${comment.id}">Delete</button>
                            </div>
                        `;
                        $('#commentList').prepend(commentHtml);
                        
                        const countSpan = $('#commentCount');
                        countSpan.text(parseInt(countSpan.text()) + 1);
                    },
                    error: function (xhr) {
                        console.log('Error:', xhr.responseText);
                        alert('Error: ' + (xhr.responseText || 'Failed to post comment.'));
                    },
                    complete: function() {
                        console.log('Complete');
                        $('#submitComment').prop('disabled', false).text('Post Comment');
                    }
                });
            });
            

            // Delete Comment
            $(document).on('click', '.delete-comment', function () {
                const btn = $(this);
                const commentId = btn.data('id');

                if (!confirm('Are you sure you want to delete this comment?')) return;

                $.ajax({
                    url: '/api/Comment/' + commentId,
                    type: 'DELETE',
                    success: function () {
                        $(`#comment-${commentId}`).fadeOut(300, function() {
                            $(this).remove();
                            const countSpan = $('#commentCount');
                            countSpan.text(parseInt(countSpan.text()) - 1);
                            
                            if ($('#commentList').children().length === 0) {
                                $('#commentList').append('<div id="noCommentsMessage" class="alert alert-info">No comments yet. Be the first to comment!</div>');
                            }
                        });
                    },
                    error: function (xhr) {
                        alert('Error: ' + (xhr.responseText || 'Failed to delete comment.'));
                    }
                });
            });
        });
    </script>


    <script>
        function showImage(index) {
            const carousel = new bootstrap.Carousel(document.getElementById('postImageCarousel'));
            carousel.to(index);
        }
    </script>
}
