@model GoWheels.Models.ApplicationUser
@{
    ViewData["Title"] = Model.Name + "'s Profile";
    
    // Safely get ViewData values with null checks
    var userPosts = ViewData["UserPosts"] as IEnumerable<GoWheels.Models.Post>;
    var userRatings = ViewData["UserRatings"] as IEnumerable<GoWheels.Models.RatingUser>;
    var isOwnProfile = ViewData["IsOwnProfile"] as bool? ?? false;
    var canRate = ViewData["CanRate"] as bool? ?? false;
    
    // Handle null collections
    if (userPosts == null) { userPosts = new List<GoWheels.Models.Post>(); }
    if (userRatings == null) { userRatings = new List<GoWheels.Models.RatingUser>(); }
}

<div class="container py-4">
    <!-- Top Section: Profile Card + Contact Card -->
    <div class="row mb-4">
        <!-- Profile Card (left) -->
        <div class="col-md-4">
            <div class="card h-100">
                <div class="card-body text-center d-flex flex-column">
                    <!-- Avatar -->
                    <div class="mb-3">
                        @if (!string.IsNullOrEmpty(Model.ImageUrl))
                        {
                            <img src="@Model.ImageUrl" alt="@Model.Name" class="rounded-circle" style="width: 120px; height: 120px; object-fit: cover;">
                        }
                        else
                        {
                            <div class="rounded-circle bg-primary d-inline-flex align-items-center justify-content-center text-white" 
                                 style="width: 120px; height: 120px;">
                                <i class="fa-solid fa-user fa-3x"></i>
                            </div>
                        }
                    </div>
                    
                    <h4>@Model.Name</h4>
                    <p class="text-muted">@Model.Email</p>
                    
                    <!-- Stats -->
                    <div class="mt-auto">
                        <div class="d-flex justify-content-around">
                            <div class="text-center">
                                <h5 class="mb-0">@userPosts.Count()</h5>
                                <small class="text-muted">Posts</small>
                            </div>
                            <div class="text-center">
                                <h5 class="mb-0">@(Model.RateAverage?.ToString("F1") ?? "0.0")</h5>
                                <small class="text-muted">Rating</small>
                            </div>
                            <div class="text-center">
                                <h5 class="mb-0">@Model.RatingsCount</h5>
                                <small class="text-muted">Reviews</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Contact Card (right) -->
        <div class="col-md-8">
            <div class="card h-100">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fa-solid fa-address-card me-2"></i>Contact Information</h5>
                </div>
                <div class="card-body d-flex flex-column">
                    <div class="flex-grow-1">
                        <!-- Email (always shows) -->
                        <div class="mb-3">
                            <div class="d-flex align-items-start">
                                <div class="me-3 text-primary">
                                    <i class="fa-solid fa-envelope fa-lg"></i>
                                </div>
                                <div>
                                    <div class="small text-muted">Email</div>
                                    <div>@Model.Email</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Phone Number -->
                        <div class="mb-3">
                            <div class="d-flex align-items-start">
                                <div class="me-3 text-success">
                                    <i class="fa-solid fa-phone fa-lg"></i>
                                </div>
                                <div>
                                    <div class="small text-muted">Phone</div>
                                    @if (!string.IsNullOrEmpty(Model.PhoneNumber))
                                    {
                                        <div>@Model.PhoneNumber</div>
                                    }
                                    else
                                    {
                                        <div class="text-muted"><i>Not provided</i></div>
                                    }
                                </div>
                            </div>
                        </div>
                        
                        <!-- Address -->
                        <div class="mb-3">
                            <div class="d-flex align-items-start">
                                <div class="me-3 text-danger">
                                    <i class="fa-solid fa-location-dot fa-lg"></i>
                                </div>
                                <div>
                                    <div class="small text-muted">Address</div>
                                    @if (!string.IsNullOrEmpty(Model.Address))
                                    {
                                        <div>@Model.Address</div>
                                    }
                                    else
                                    {
                                        <div class="text-muted"><i>Not provided</i></div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Member Since at bottom -->
                    <div class="mt-3 pt-3 border-top">
                        <div class="d-flex align-items-center">
                            <div class="me-3 text-info">
                                <i class="fa-solid fa-calendar-days"></i>
                            </div>
                            <div>
                                <small class="text-muted">Member since</small>
                                <div>@DateTime.Now.ToString("MMMM yyyy")</div>
                            </div>
                        </div>
                    </div>
                    <!-- Edit contacts if user -->
                    @if (isOwnProfile)
                    {
                        <div class="mt-3 pt-3 border-top">
                            <a asp-action="EditContact" class="btn btn-outline-primary btn-sm">
                                <i class="fa-solid fa-pen me-1"></i>Edit Contact Information
                            </a>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    
    <!-- Rating Section (centered below, only if can rate) -->
    @if (canRate)
    {
        <div class="row mb-4">
            <div class="col-md-6 offset-md-3">
                <div class="card">
                    <div class="card-header bg-light text-center">
                        <h5 class="mb-0"><i class="fa-solid fa-star me-2"></i>Rate @Model.Name</h5>
                    </div>
                    <div class="card-body text-center">
                        <p class="mb-3">How was your experience with this seller?</p>
                        <div id="userRatingStars" class="fs-3 text-warning mb-3" style="cursor: pointer;">
                            @for (int i = 1; i <= 5; i++)
                            {
                                <i class="bi bi-star" data-value="@i"></i>
                            }
                        </div>
                        <button id="submitUserRating" class="btn btn-primary">
                            <i class="fa-solid fa-check me-1"></i>Submit Rating
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }
    
    <!-- User's Posts Section -->
    <div class="row">
        <div class="col-12">
            <h4 class="mb-3">@(isOwnProfile ? "Your Posts" : "User's Posts")</h4>
            
            @if (userPosts.Any())
            {
                <div class="row">
                    @foreach (var post in userPosts)
                    {
                        <div class="col-md-6 col-lg-4 mb-4">
                            <partial name="_Post" model="post" />
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="alert alert-info">
                    <i class="fa-solid fa-info-circle me-2"></i>
                    @(isOwnProfile ? "You haven't posted any cars yet." : "This user hasn't posted any cars yet.")
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    @if (canRate)
    {
        <script>
            $(document).ready(function () {
                const userId = "@Model.Id";
                let selectedRating = 0;

                // Rating Stars
                $('#userRatingStars i').hover(function () {
                    const val = $(this).data('value');
                    fillStars(val);
                }, function () {
                    fillStars(selectedRating);
                }).click(function () {
                    selectedRating = $(this).data('value');
                    fillStars(selectedRating);
                });

                function fillStars(val) {
                    $('#userRatingStars i').each(function () {
                        const starVal = $(this).data('value');
                        if (starVal <= val) {
                            $(this).removeClass('bi-star').addClass('bi-star-fill');
                        } else {
                            $(this).removeClass('bi-star-fill').addClass('bi-star');
                        }
                    });
                }

                // Submit Rating
                $('#submitUserRating').click(function () {
                    if (selectedRating === 0) {
                        alert('Please select a rating value.');
                        return;
                    }

                    $.ajax({
                        url: '/api/Rating/User',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            userId: userId,
                            value: selectedRating
                        }),
                        success: function () {
                            alert('Rating submitted!');
                            location.reload();
                        },
                        error: function (xhr) {
                            alert('Error: ' + (xhr.responseText || 'Failed to submit rating.'));
                        }
                    });
                });
            });
        </script>
    }
}